- name: Elasticsearch with custom configuration
  hosts: test
  become: true
  become_user: root
  roles:
  vars:
    first_run: false
    apt_cache_valid_time: 86400
  pre_tasks:
  - name: 'install python2'
    raw: sudo apt-get -y install python-simplejson
    when: first_run
  tasks:
  - name: Update apt cache
    apt: update_cache=yes cache_valid_time={{ apt_cache_valid_time }}


  - name: Check Java
    shell: command -v java
    register: java_installed
    ignore_errors: True
    changed_when: False
  - name: Add Oracle Java Repository
    apt_repository: repo='ppa:webupd8team/java' update_cache=yes
    when: not java_installed
  - name: Accept Java 8 License
    when: not java_installed
    debconf: name='oracle-java8-installer' question='shared/accepted-oracle-license-v1-1' value='true' vtype='select'
  - name: Install Oracle Java 8
    apt: name={{item}} state=latest
    with_items:
      - oracle-java8-installer
      - ca-certificates
      - oracle-java8-set-default
    when: not java_installed

  - name: add Elastic key
    apt_key: url=https://artifacts.elastic.co/GPG-KEY-elasticsearch state=present
  - name: install necessary packages to get elastic stack
    apt: name={{item}} state=present
    with_items:
      - aptitude
      - apt-transport-https
  - name: install elasticsearch repository
    apt_repository: repo="deb https://artifacts.elastic.co/packages/5.x/apt stable main" state=present update_cache=yes

    # Need to remove the allow_unauthentication, but currently this fails with
    # Install these packages without verification? [y/N]
  - name: install packages
    apt: name={{item}} state=present allow_unauthenticated=yes
    with_items:
      - logstash
      - kibana
      - elasticsearch

